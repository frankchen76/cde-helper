<!--This file is auto generated by Teams Toolkit to provide you instructions and reference code to implement single sign on. -->
<!--This file is used during the Teams Bot authentication flow to assist with retrieval of the access token.-->
<!--If you're not familiar with this, do not alter or remove this file from your project.-->
<html>

<head>
    <title>Login End Page</title>
    <meta charset="utf-8" />
</head>

<body>
    <script src="https://res.cdn.office.net/teams-js/2.17.0/js/MicrosoftTeams.min.js"
        integrity="sha384-xp55t/129OsN192JZYLP0rGhzjCF9aYtjY0LVtXvolkDrBe4Jchylp56NrUYJ4S2"
        crossorigin="anonymous"></script>
    <!-- Office JavaScript API -->
    <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1.1/hosted/office.js"></script>
    <div id="divError"></div>
    <script type="text/javascript">

        microsoftTeams.app.initialize().then(() => {
            const context = microsoftTeams.app.getContext().then((context) => {
                console.log("hostName:", context.app.host.name);

            });
            processCode(true);
        }).catch((error) => {
            console.error("Error initializing teams app", error);
            console.error("Use Office API to get the code");
            Office.onReady(function () {
                // Add any initialization code for your dialog here.
                processCode(false);
            });
        });
        // microsoftTeams.app.initialize().then(() => {
        //     let hashParams = getHashParameters();

        //     if (hashParams.get("error")) {
        //         // Authentication failed
        //         handleAuthError(hashParams.get("error"), hashParams);
        //     } else if (hashParams.get("code")) {
        //         // Get the stored state parameter and compare with incoming state
        //         let expectedState = localStorage.getItem("state");
        //         if (expectedState !== hashParams.get("state")) {
        //             // State does not match, report error
        //             handleAuthError("StateDoesNotMatch", hashParams);
        //         } else {
        //             microsoftTeams.authentication.notifySuccess();
        //         }
        //     } else {
        //         // Unexpected condition: hash does not contain error or access_token parameter
        //         handleAuthError("UnexpectedFailure", hashParams);
        //     }
        // });
        function processCode(isTeams) {
            let hashParams = getHashParameters();
            //var currentURL = new URL(window.location);
            var code = hashParams.get("code");
            var state = hashParams.get("state");
            var error = hashParams.get("error");

            if (error) {
                // Authentication failed
                handleAuthError(error, hashParams);
            } else if (code) {
                // Get the stored state parameter and compare with incoming state
                let expectedState = localStorage.getItem("state");
                if (expectedState !== state) {
                    // State does not match, report error
                    handleAuthError("StateDoesNotMatch", hashParams);
                } else {
                    const retVal = {
                        state: state,
                        code: code
                    };

                    if (isTeams) {
                        microsoftTeams.authentication.notifySuccess(JSON.stringify(retVal));
                        //microsoftTeams.authentication.notifySuccess(retVal);
                    } else {
                        Office.context.ui.messageParent(JSON.stringify(retVal));

                    }
                }
            } else {
                // Unexpected condition: hash does not contain error or access_token parameter
                handleAuthError("UnexpectedFailure", hashParams);
            }
        }
        // Parse hash parameters into key-value pairs
        function getHashParameters() {
            let hashParams = new Map();
            location.hash
                .substr(1)
                .split("&")
                .forEach(function (item) {
                    let s = item.split("="),
                        k = s[0],
                        v = s[1] && decodeURIComponent(s[1]);
                    hashParams.set(k, v);
                });
            return hashParams;
        }

        // Show error information
        function handleAuthError(errorType, errorMessage) {
            const err = JSON.stringify({
                error: encodeURIComponent(errorType),
                message: encodeURIComponent(JSON.stringify(errorMessage)),
            });
            let para = document.createElement("p");
            let node = document.createTextNode(err);
            para.appendChild(node);

            let element = document.getElementById("divError");
            element.appendChild(para);
        }
    </script>
</body>

</html>